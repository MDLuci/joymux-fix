name: Patch ONE odroidgo3-joypad DTB

on:
  workflow_dispatch:
    inputs:
      dtb_path:
        description: "Nombre del archivo DTB (ej: rf3536k3ka.dtb)"
        required: true
        default: "rf3536k3ka.dtb"
      node_path:
        description: "Nombre del nodo (PARA TU K36 USA: play_joystick)"
        required: true
        default: "play_joystick"
      amux_map:
        description: "Permutacion: LX,RX,LY,RY"
        required: true
        default: "LX,RX,LY,RY"
      invert_axes:
        description: "Inversion: unchanged"
        required: false
        default: "unchanged"
      tuning:
        description: "Sensibilidad: 200"
        required: false
        default: "200"

permissions:
  contents: read

jobs:
  patch_one:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check script & DTB exist
        shell: bash
        run: |
          if [ ! -f tools/patch_og3_joypad.py ]; then
            echo "Error: tools/patch_og3_joypad.py no encontrado." >&2; exit 1
          fi
          if [ ! -f "${{ github.event.inputs.dtb_path }}" ]; then
            echo "Error: DTB no encontrado." >&2; exit 1
          fi

      - name: Install dtc
        run: |
          sudo apt-get update
          sudo apt-get install -y device-tree-compiler

      - name: Patch DTB
        id: patch
        shell: bash
        run: |
          set -euo pipefail
          python3 tools/patch_og3_joypad.py \
            --in_dtb "${{ github.event.inputs.dtb_path }}" \
            --node_path "${{ github.event.inputs.node_path }}" \
            --amux_csv "${{ github.event.inputs.amux_map }}" \
            --invert_csv "${{ github.event.inputs.invert_axes }}" \
            --tuning_str "${{ github.event.inputs.tuning }}"

          in_base="$(basename "${{ github.event.inputs.dtb_path }}")"
          mv patched.dtb "${in_base}"
          echo "outfile=${in_base}" >> "$GITHUB_OUTPUT"
          echo "base=${in_base}" >> "$GITHUB_OUTPUT"

      - name: Upload patched DTB
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.patch.outputs.base }}
          path: ${{ steps.patch.outputs.outfile }}
          retention-days: 1
